name: Update Vietnam IP Lists by City

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-ip-lists:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Download and process IP data
        run: |
          python << 'EOF'
          import requests
          import gzip
          import csv
          from collections import defaultdict
          import ipaddress
          import io
          import unicodedata
          import re
          
          def normalize_city_name(city):
              """Chuyển tên thành phố về dạng chữ thường, bỏ dấu, bỏ khoảng trắng"""
              if not city or city == 'Unknown':
                  return 'unknown'
              
              # Bỏ dấu tiếng Việt
              city = unicodedata.normalize('NFD', city)
              city = ''.join(char for char in city if unicodedata.category(char) != 'Mn')
              
              # Chuyển thường, bỏ khoảng trắng và ký tự đặc biệt
              city = city.lower()
              city = re.sub(r'[^a-z0-9]', '', city)
              
              return city if city else 'unknown'
          
          print("Đang tải DB-IP City Lite database...")
          url = "https://download.db-ip.com/free/dbip-city-lite-2025-12.csv.gz"
          response = requests.get(url)
          
          print("Đang giải nén và xử lý dữ liệu...")
          content = gzip.decompress(response.content)
          
          city_ips = defaultdict(list)
          vietnam_networks = []
          
          # Đọc CSV
          csv_file = io.StringIO(content.decode('utf-8'))
          reader = csv.reader(csv_file, delimiter='\t')
          
          processed = 0
          for row in reader:
              try:
                  if len(row) >= 5 and row[3] == 'VN':  # Country code = VN
                      ip_start = row[0]
                      ip_end = row[1]
                      region = row[4] if len(row) > 4 else 'Unknown'  # Cột thứ 5 (index 4)
                      
                      # Convert IP range to CIDR networks
                      try:
                          start_ip = ipaddress.IPv4Address(ip_start)
                          end_ip = ipaddress.IPv4Address(ip_end)
                          
                          # Tạo CIDR từ range
                          cidrs = list(ipaddress.summarize_address_range(start_ip, end_ip))
                          
                          # Chuẩn hóa tên thành phố - ĐƠN GIẢN
                          city_normalized = normalize_city_name(region)
                          
                          # Thêm vào danh sách
                          for cidr in cidrs:
                              network_str = str(cidr)
                              city_ips[city_normalized].append(network_str)
                              vietnam_networks.append(network_str)
                          
                          processed += 1
                          if processed % 1000 == 0:
                              print(f"Đã xử lý {processed} dải IP...")
                              
                      except (ipaddress.AddressValueError, ValueError):
                          # Skip IPv6 or invalid IPs
                          continue
                          
              except Exception as e:
                  print(f"Lỗi xử lý dòng: {e}")
                  continue
          
          print(f"\nTổng cộng tìm thấy {len(vietnam_networks)} networks IPv4 của Việt Nam")
          print(f"Phân bổ vào {len(city_ips)} thành phố/tỉnh")
          
          # Lưu file vietnam.txt (tất cả networks)
          with open('vietnam.txt', 'w') as f:
              for network in sorted(set(vietnam_networks)):
                  f.write(network + '\n')
          print(f"Đã lưu vietnam.txt với {len(set(vietnam_networks))} networks")
          
          # Lưu file cho từng thành phố
          print("\nĐang tạo file cho từng thành phố...")
          for city, networks in sorted(city_ips.items()):
              filename = f"{city}.txt"
              # Loại bỏ duplicate và sort
              unique_networks = sorted(set(networks))
              with open(filename, 'w') as f:
                  for network in unique_networks:
                      f.write(network + '\n')
              print(f"Đã tạo {filename} với {len(unique_networks)} networks")
          
          print("\n=== Top 10 thành phố có nhiều networks nhất ===")
          sorted_cities = sorted(city_ips.items(), key=lambda x: len(x[1]), reverse=True)[:10]
          for city, networks in sorted_cities:
              print(f"{city}: {len(set(networks))} networks")
          
          print("\nHoàn thành!")
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.txt
          git commit -m "Update Vietnam IP lists [$(date +'%Y-%m-%d')]" || exit 0
          git push
